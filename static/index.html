<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>الشبكة الطبية - الأهلي للخدمات الطبية</title>
<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
    :root {
        --primary-green: #006A4E;
        --primary-orange: #F58220;
        --special-green-teal: #008080;
        --accent-light-green: #E6F0ED;
        --white: #ffffff;
        --light-gray: #f0f2f5;
        --medium-gray: #e9ecef;
        --text-dark: #212529;
        --text-muted: #6c757d;
        --danger-red: #dc3545;
        --primary-glow: rgba(0, 106, 78, 0.3);
        --star-yellow: #FFC107;
    }
    html { scroll-behavior: smooth; }
    body {
        font-family: 'Cairo', sans-serif;
        background-color: var(--light-gray);
        margin: 0; padding: 0;
        display: flex; flex-direction: column;
        align-items: center; color: var(--text-dark);
        line-height: 1.7;
    }
    .logo-container-full-width {
        width: 100%; background: var(--white);
        text-align: center; padding: 20px 0;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .logo-image { max-width: 900px; width: 90%; height: auto; }
    .page {
        background: var(--white); width: 100%;
        max-width: 900px; padding: 25px;
        box-shadow: 0 5px 30px rgba(0,0,0,0.1);
        border-radius: 15px; box-sizing: border-box;
        overflow: hidden; margin: 20px 15px;
    }
    .info-professional {
        background-color: var(--accent-light-green); border-radius: 10px;
        padding: 20px; margin-bottom: 25px; text-align: right;
        border: 1px solid var(--medium-gray);
    }
    .info-professional h1 {
        font-size: 20px; margin-top: 0; margin-bottom: 5px;
        color: var(--primary-green);
    }
    .info-professional .en-title {
        font-family: 'Poppins', sans-serif; font-size: 14px;
        color: var(--text-muted); margin-bottom: 20px; display: block;
    }
    .info-professional .info-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }
    .info-item { display: flex; align-items: center; gap: 15px; }
    .info-item i { font-size: 22px; color: var(--primary-orange); width: 25px; text-align: center; }
    .info-item-text a { color: var(--text-dark); text-decoration: none; font-weight: 600; }
    .info-item-text a:hover { color: var(--primary-green); }
    .info-item-text .en { font-family: 'Poppins', sans-serif; font-size: 0.8em; color: var(--text-muted); display: block; }
    
    .feature-box {
        text-align: right; margin-bottom: 25px; padding: 20px;
        background-color: var(--accent-light-green); border: 1px solid var(--medium-gray);
        border-radius: 10px;
    }
    .feature-box h2 {
        font-size: 18px; color: var(--primary-green);
        margin-top: 0; margin-bottom: 5px;
    }
    .feature-box h2 .en-subtitle {
        font-family: 'Poppins', sans-serif; font-size: 13px; font-weight: 400;
        color: var(--text-muted); display: block; margin-top: 2px;
    }
    .feature-box p { font-size: 14px; color: var(--text-muted); margin-bottom: 20px; }
    
    .feature-box textarea, .feature-box input[type="text"] {
        width: 100%; padding: 12px 15px; border-radius: 8px;
        border: 1px solid #ccc; font-family: 'Cairo', sans-serif;
        font-size: 14px; box-sizing: border-box; background-color: var(--white);
        margin-bottom: 10px;
    }
    .feature-box button {
        background-color: var(--primary-green); color: var(--white);
        border: none; padding: 12px 25px; font-size: 16px;
        font-weight: 600; border-radius: 8px; cursor: pointer;
        transition: all 0.3s; width: 100%; margin-top: 10px;
    }
    .feature-box button:hover:not(:disabled) { background-color: #005a41; }
    .feature-box button:disabled { background-color: #999; cursor: not-allowed; }
    
    .loader {
        border: 4px solid var(--medium-gray); border-top: 4px solid var(--primary-green);
        border-radius: 50%; width: 30px; height: 30px;
        animation: spin 1s linear infinite; margin: 20px auto; display: none;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .results-area { margin-top: 30px; }
    .section-title {
        font-size: 22px; color: var(--primary-green);
        padding-bottom: 10px; margin-bottom: 20px;
        border-bottom: 3px solid var(--primary-orange);
    }

    /* --- تصميم جديد لبطاقة مقدم الخدمة --- */
    .provider-card {
        background-color: var(--white); border: 1px solid var(--medium-gray);
        border-radius: 12px; margin-bottom: 15px; padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: all 0.3s ease;
        position: relative; overflow: hidden;
    }
    .provider-card.best-match {
        border-color: var(--primary-green);
        box-shadow: 0 8px 25px var(--primary-glow);
    }
    .best-match-badge {
        position: absolute; top: 15px; left: -40px;
        background-color: var(--primary-green); color: white;
        padding: 5px 40px; font-size: 12px; font-weight: bold;
        transform: rotate(-45deg); display: flex; align-items: center; gap: 5px;
    }
    .best-match-badge .fa-star { color: var(--star-yellow); }
    
    .provider-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    .provider-icon {
        width: 50px; height: 50px; background-color: var(--accent-light-green);
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 22px; color: var(--primary-green); flex-shrink: 0;
    }
    .provider-name { font-size: 18px; font-weight: 700; color: var(--text-dark); }
    .provider-specialty { font-size: 14px; color: var(--text-muted); }
    
    .provider-info-grid {
        display: grid; grid-template-columns: 1fr; gap: 12px;
        margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--medium-gray);
    }
    .provider-info-item { display: flex; align-items: flex-start; gap: 12px; font-size: 15px; }
    .provider-info-item i {
        color: var(--primary-orange); width: 20px; text-align: center;
        margin-top: 3px; font-size: 16px;
    }
    .provider-info-item .phones-list {
        display: flex; flex-wrap: wrap; gap: 10px;
        font-family: 'Poppins', sans-serif; font-weight: 600;
    }
    .provider-info-item .phones-list span { background-color: var(--light-gray); padding: 2px 8px; border-radius: 5px; }
    
    .provider-nav {
        display: flex; justify-content: flex-end; gap: 10px;
        margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--medium-gray);
    }
    .nav-btn {
        background-color: var(--accent-light-green); border: 1px solid var(--medium-gray);
        color: var(--primary-green); width: 40px; height: 40px;
        border-radius: 50%; cursor: pointer; transition: all 0.2s ease-in-out;
        font-size: 16px; display: flex; align-items: center; justify-content: center;
        text-decoration: none;
    }
    .nav-btn:hover {
        background-color: var(--primary-green); color: var(--white); transform: scale(1.1);
    }
    .nav-btn.map-btn { background-color: var(--primary-orange); color: var(--white); }
    .nav-btn.map-btn:hover { background-color: #d9711c; }

    #no-results {
        text-align: center; padding: 40px 20px; background-color: var(--accent-light-green);
        border-radius: 8px; color: var(--text-muted); font-weight: 600; display: none;
    }
    .ai-result-area { margin-top: 20px; }

    /* --- تصميم بطاقة التحليل والنصائح --- */
    .analysis-card { background-color: var(--white); border: 2px solid var(--primary-green); box-shadow: 0 0 20px var(--primary-glow); border-radius: 10px; padding: 20px; text-align: right; }
    .analysis-card .disclaimer { background-color: #fff3cd; border-right: 5px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .analysis-card .disclaimer strong { color: #856404; }
    .analysis-section-title { font-size: 18px; font-weight: 700; color: var(--primary-green); margin-top: 20px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid var(--primary-orange); }
    .analysis-card ul { padding-right: 20px; margin: 0; }
    .analysis-card li { margin-bottom: 10px; line-height: 1.8; }
    .next-step-guidance { margin-top: 20px; padding: 15px; background-color: var(--accent-light-green); border-radius: 8px; text-align: center; font-weight: 600; }

    /* --- تصميم قسم رفع الملفات --- */
    .upload-area { border: 2px dashed #ccc; border-radius: 10px; padding: 20px; margin-bottom: 15px; transition: border-color 0.3s, background-color 0.3s; }
    .upload-area.drag-over { border-color: var(--primary-green); background-color: var(--accent-light-green); }
    #report-files-input { display: none; }
    .upload-label { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); text-align: center; }
    .upload-label i { font-size: 36px; margin-bottom: 10px; color: var(--primary-green); }
    .upload-label span { font-size: 16px; font-weight: 600; }
    #file-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; justify-content: center; }
    .preview-item { position: relative; width: 80px; height: 80px; }
    .preview-item .file-icon { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; background-color: var(--light-gray); border-radius: 8px; border: 1px solid #ddd; }
    .preview-item .file-icon i { font-size: 30px; color: var(--primary-green); }
    .preview-item .file-icon span { font-size: 10px; color: var(--text-muted); margin-top: 5px; word-break: break-all; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-align: center; }
    .remove-file-btn { position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: var(--danger-red); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; z-index: 1; }

    /* --- قسم الخريطة --- */
    .location-section { margin-top: 40px; text-align: center; }
    .location-section h2 { font-size: 20px; color: var(--primary-green); margin-bottom: 15px; }
    .location-map { position: relative; width: 100%; height: 300px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
    .location-map iframe { width: 100%; height: 100%; border: 0; }
    .location-address { margin-top: 15px; font-size: 16px; color: var(--text-muted); line-height: 1.7; }
</style>
</head>
<body>

<div class="logo-container-full-width">
    <img src="https://i.ibb.co/JFMjRLSf/Cover-Linkedin-AMC-new.png" alt="AMC Logo" class="logo-image">
</div>

<div class="page" id="page-top">

    <div class="info-professional">
        <h1>دليل مقدمي الخدمة الطبية <span class="en-title">Medical Network Directory</span></h1>
        <div class="info-grid">
            <div class="info-item">
                <i class="fa-solid fa-phone"></i>
                <div class="info-item-text">الخط الساخن: <strong>19462</strong> <span class="en">HOTLINE</span></div>
            </div>
            <div class="info-item">
                <i class="fa-solid fa-globe"></i>
                <div class="info-item-text"><a href="https://www.ahlymedical.com/" target="_blank">www.ahlymedical.com</a> <span class="en">Our Website</span></div>
            </div>
            <div class="info-item">
                <i class="fa-solid fa-map-marker-alt"></i>
                <div class="info-item-text"> 57 برج الجامعة، شارع مراد، الجيزة <span class="en">57 El Gamaa Tower, Mourad St, Giza</span> </div>
            </div>
        </div>
    </div>

    <!-- AI Tools Section -->
    <div class="feature-box" id="ai-tools-box">
        <h2><i class="fa-solid fa-robot"></i> استخدم المساعد الذكي <span class="en-subtitle">AI Assistant Tools</span></h2>
        
        <!-- Tool 1: Symptoms and Location Search -->
        <p>صف الأعراض التي تشعر بها وحدد موقعك، وسيقوم المساعد الذكي بترشيح مقدم الخدمة الأنسب لك.</p>
        <textarea id="symptoms-input" rows="3" placeholder="اكتب الأعراض هنا... مثال: أشعر بألم شديد في الظهر مع صعوبة في الحركة"></textarea>
        <input type="text" id="location-input" placeholder="اكتب المنطقة أو المحافظة هنا... مثال: الطالبية هرم أو الجيزة">
        <button id="symptoms-search-btn">✨ أرشدني لأفضل مقدم خدمة</button>
        <div id="loader-symptoms" class="loader"></div>
        
        <hr style="margin: 25px 0; border: 0; border-top: 1px solid var(--medium-gray);">
        
        <!-- Tool 2: Analyze Medical Reports -->
        <p>ارفع تقاريرك أو التحاليل الطبية (صور أو PDF)، وسيقوم المساعد الذكي بتحليلها وتقديم شرح ونصائح أولية.</p>
        <div class="upload-area" id="upload-area">
            <input type="file" id="report-files-input" multiple accept="image/png, image/jpeg, image/webp, application/pdf">
            <label for="report-files-input" class="upload-label">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <span>اختر ملفات التقارير أو اسحبها إلى هنا <br> <small>(Choose or drag & drop your reports)</small></span>
            </label>
        </div>
        <div id="file-preview-container"></div>
        <button id="analyze-reports-btn" disabled><i class="fa-solid fa-microscope"></i> حلل التقارير</button>
        <div id="loader-analysis" class="loader"></div>
    </div>

    <!-- AI & Search Results Content -->
    <div class="results-area" id="results-area">
        <!-- AI Initial Advice will be injected here -->
        <div id="ai-advice-container"></div>
        <!-- Analysis Result Area -->
        <div id="analysis-result-area" class="ai-result-area"></div>
        <!-- Network search results will be injected here -->
        <div id="network-container"></div>
        <!-- No results message -->
        <div id="no-results">
            <i class="fa-solid fa-box-open" style="font-size: 40px; margin-bottom: 15px;"></i>
            <p>عفواً، لا توجد نتائج مطابقة لبحثك. <br> <small>No results found matching your criteria.</small></p>
        </div>
    </div>

    <!-- Map Section -->
    <div class="location-section" id="location-section">
        <h2> <i class="fa-solid fa-map-location-dot"></i> موقعنا على الخريطة <br> <small class="en-subtitle" style="color: var(--text-muted)">Our Location on Map</small></h2>
        <div class="location-map">
            <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3454.495955148021!2d31.20786357555355!3d30.02262187493399!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x145846e49123862b%3A0x12f5a6396017366d!2sEl%20Gamaa%20Tower!5e0!3m2!1sen!2seg" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
        <p class="location-address">57 برج الجامعة، شارع مراد، الجيزة</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- عناصر الواجهة الرئيسية ---
    const symptomsSearchBtn = document.getElementById('symptoms-search-btn');
    const symptomsInput = document.getElementById('symptoms-input');
    const locationInput = document.getElementById('location-input');
    const loaderSymptoms = document.getElementById('loader-symptoms');
    
    const analyzeBtn = document.getElementById('analyze-reports-btn');
    const analysisResultArea = document.getElementById('analysis-result-area');
    const loaderAnalysis = document.getElementById('loader-analysis');

    const resultsArea = document.getElementById('results-area');
    const aiAdviceContainer = document.getElementById('ai-advice-container');
    const networkContainer = document.getElementById('network-container');
    const noResultsDiv = document.getElementById('no-results');

    // --- أيقونات احترافية للتخصصات ---
    const specialtyIcons = {
        'default': 'fa-solid fa-user-doctor', 'باطنة': 'fa-solid fa-stethoscope',
        'علاج طبيعي': 'fa-solid fa-person-walking', 'اسنان': 'fa-solid fa-tooth',
        'صيدلية': 'fa-solid fa-pills', 'قلب واوعية دموية': 'fa-solid fa-heart-pulse',
        'مخ وأعصاب': 'fa-solid fa-brain', 'معمل': 'fa-solid fa-vial-virus',
        'أشعة': 'fa-solid fa-x-ray', 'نساء وتوليد': 'fa-solid fa-person-pregnant',
        'اطفال': 'fa-solid fa-child-reaching', 'عظام': 'fa-solid fa-bone',
        'جلدية': 'fa-solid fa-hand-dots', 'انف واذن وحنجرة': 'fa-solid fa-head-side-cough',
        'عيون': 'fa-solid fa-eye', 'صدرية': 'fa-solid fa-lungs',
        'جراحة عامة': 'fa-solid fa-user-doctor', 'مسالك بولية': 'fa-solid fa-toilet-paper',
        'مستشفى': 'fa-solid fa-hospital', 'مركز طبي': 'fa-solid fa-house-medical',
        'بصريات': 'fa-solid fa-glasses'
    };

    function getIconForSpecialty(specialty) {
        if (!specialty) return specialtyIcons['default'];
        const specialtyLower = specialty.toLowerCase();
        for (const key in specialtyIcons) {
            if (specialtyLower.includes(key.toLowerCase())) {
                return specialtyIcons[key];
            }
        }
        return specialtyIcons['default'];
    }
    
    // --- دالة عرض النتائج بتصميم احترافي ---
    function renderResults(bestMatch, otherResults) {
        networkContainer.innerHTML = '';
        const allResults = (bestMatch ? bestMatch : []).concat(otherResults ? otherResults : []);

        noResultsDiv.style.display = allResults.length === 0 ? 'block' : 'none';

        if (allResults.length > 0) {
            const title = document.createElement('h2');
            title.className = 'section-title';
            title.textContent = `نتائج البحث (${allResults.length})`;
            networkContainer.appendChild(title);

            const cardFragment = document.createDocumentFragment();
            allResults.forEach((provider, index) => {
                const isBestMatch = index === 0 && bestMatch && bestMatch.length > 0;
                
                const card = document.createElement('div');
                card.className = `provider-card ${isBestMatch ? 'best-match' : ''}`;
                
                const iconClass = getIconForSpecialty(provider.provider_type || provider.specialty_sub);

                // --- بناء قائمة الهواتف والخط الساخن ---
                let phonesHTML = provider.phones && provider.phones.length > 0
                    ? `<div class="phones-list">${provider.phones.map(p => `<span>${p}</span>`).join('')}</div>`
                    : 'غير متوفر';
                let hotlineHTML = provider.hotline ? `<div class="phones-list"><span>${provider.hotline}</span></div>` : 'غير متوفر';

                // --- توليد رابط خرائط جوجل الذكي ---
                const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(provider.name + ', ' + provider.address)}`;

                card.innerHTML = `
                    ${isBestMatch ? '<div class="best-match-badge"><i class="fa-solid fa-star"></i> الترشيح الأنسب</div>' : ''}
                    <div class="provider-header">
                        <div class="provider-icon"><i class="${iconClass}"></i></div>
                        <div>
                            <div class="provider-name">${provider.name || 'غير متوفر'}</div>
                            <div class="provider-specialty">${provider.provider_type || ''} / ${provider.specialty_sub || ''}</div>
                        </div>
                    </div>
                    <div class="provider-info-grid">
                        <div class="provider-info-item">
                            <i class="fa-solid fa-location-dot"></i>
                            <div>${provider.address || 'غير متوفر'}</div>
                        </div>
                        <div class="provider-info-item">
                            <i class="fa-solid fa-phone-volume"></i>
                            <div>${phonesHTML}</div>
                        </div>
                        <div class="provider-info-item">
                            <i class="fa-solid fa-headset"></i>
                            <div>${hotlineHTML}</div>
                        </div>
                    </div>
                    <div class="provider-nav">
                        <a href="${googleMapsUrl}" target="_blank" class="nav-btn map-btn" title="عرض على الخريطة (GPS)"><i class="fa-solid fa-diamond-turn-right"></i></a>
                        <button class="nav-btn nav-btn-up" title="العودة للبحث"><i class="fa-solid fa-arrow-up"></i></button>
                        <button class="nav-btn nav-btn-down" title="الذهاب لخريطة المقر الرئيسي"><i class="fa-solid fa-arrow-down"></i></button>
                    </div>
                `;
                cardFragment.appendChild(card);
            });
            networkContainer.appendChild(cardFragment);
        }
    }

    // --- وظيفة البحث بالأعراض والموقع ---
    async function handleSymptomsSearch() {
        const symptomsText = symptomsInput.value.trim();
        const locationText = locationInput.value.trim();
        if (!symptomsText || !locationText) {
            alert('من فضلك، قم بوصف الأعراض وتحديد موقعك.');
            return;
        }
        
        loaderSymptoms.style.display = 'block';
        aiAdviceContainer.innerHTML = '';
        analysisResultArea.innerHTML = '';
        networkContainer.innerHTML = '';
        noResultsDiv.style.display = 'none';
        symptomsSearchBtn.disabled = true;

        try {
            const response = await fetch('/api/symptoms-search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symptoms: symptomsText, location: locationText })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'فشل الاتصال بالخادم.');
            }

            const result = await response.json();
            
            // عرض النصيحة الطبية الأولية
            if (result.initial_advice) {
                aiAdviceContainer.innerHTML = `<div class="analysis-card" style="margin-bottom: 20px;"><h3 class="analysis-section-title">نصيحة طبية أولية</h3><p>${result.initial_advice}</p></div>`;
            }

            // عرض النتائج
            renderResults(result.best_match, result.other_results);
            resultsArea.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            aiAdviceContainer.innerHTML = `<p style="color:var(--danger-red); text-align:center;">عفواً، حدث خطأ تقني: ${error.message}</p>`;
        } finally {
            loaderSymptoms.style.display = 'none';
            symptomsSearchBtn.disabled = false;
        }
    }
    
    // --- وظيفة تحليل التقارير ---
    async function handleAIAnalysis() {
        if (uploadedFiles.length === 0) {
            alert('يرجى اختيار ملف واحد على الأقل لتحليله.');
            return;
        }
        
        loaderAnalysis.style.display = 'block';
        analysisResultArea.innerHTML = '';
        aiAdviceContainer.innerHTML = '';
        networkContainer.innerHTML = '';
        noResultsDiv.style.display = 'none';
        analyzeBtn.disabled = true;

        try {
            const filesPayload = await Promise.all(uploadedFiles.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve({ mime_type: file.type, data: reader.result.split(',')[1] });
                    reader.onerror = error => reject(error);
                });
            }));

            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: filesPayload })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'فشل الاتصال بالخادم.');
            }

            const result = await response.json();
            
            analysisResultArea.innerHTML = `
                <div class="analysis-card">
                    <div class="disclaimer"><i class="fa-solid fa-triangle-exclamation"></i> <strong>تنبيه هام:</strong> هذا التحليل هو مجرد إرشاد أولي ولا يغني عن استشارة الطبيب.</div>
                    <h3 class="analysis-section-title">شرح مبدئي للتقرير</h3>
                    <p>${result.interpretation}</p>
                    <h3 class="analysis-section-title">نصائح وإرشادات مؤقتة</h3>
                    <ul>${result.temporary_advice.map(item => `<li>${item}</li>`).join('')}</ul>
                    <h3 class="analysis-section-title">التخصص الموصى به</h3>
                    <p><strong>${result.recommended_specialty}</strong></p>
                    <div class="next-step-guidance">
                        <i class="fa-solid fa-circle-info"></i> 
                        الخطوة التالية: يمكنك الآن استخدام أداة البحث بالأعراض أعلاه، اكتب "${result.recommended_specialty}" مع موقعك للعثور على أفضل مقدم خدمة لك.
                    </div>
                </div>`;
            analysisResultArea.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            analysisResultArea.innerHTML = `<p style="color:var(--danger-red); text-align:center;">عفواً، حدث خطأ تقني: ${error.message}</p>`;
        } finally {
            loaderAnalysis.style.display = 'none';
            analyzeBtn.disabled = uploadedFiles.length === 0;
        }
    }

    // --- ربط الأزرار بوظائفها ---
    symptomsSearchBtn.addEventListener('click', handleSymptomsSearch);
    analyzeBtn.addEventListener('click', handleAIAnalysis);

    // --- التعامل مع أزرار التنقل داخل البطاقات ---
    document.body.addEventListener('click', function(event) {
        if (event.target.closest('.nav-btn-up')) {
            document.getElementById('ai-tools-box').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        if (event.target.closest('.nav-btn-down')) {
            document.getElementById('location-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });

    // --- منطقة التعامل مع رفع الملفات (تبقى كما هي) ---
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('report-files-input');
    const previewContainer = document.getElementById('file-preview-container');
    let uploadedFiles = [];
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false));
    ['dragenter', 'dragover'].forEach(eventName => uploadArea.addEventListener(eventName, () => uploadArea.classList.add('drag-over'), false));
    ['dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('drag-over'), false));
    uploadArea.addEventListener('drop', e => handleFiles(e.dataTransfer.files), false);
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
    function handleFiles(files) {
        [...files].forEach(file => { if(uploadedFiles.length < 5) uploadedFiles.push(file) }); // Limit to 5 files
        renderPreviews();
    }
    function renderPreviews() {
        previewContainer.innerHTML = '';
        uploadedFiles.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'preview-item';
            let iconClass = file.type.startsWith('image/') ? 'fa-solid fa-file-image' : (file.type.includes('pdf') ? 'fa-solid fa-file-pdf' : 'fa-solid fa-file');
            item.innerHTML = `<div class="file-icon"><i class="${iconClass}"></i><span>${file.name}</span></div><button class="remove-file-btn" data-index="${index}">&times;</button>`;
            previewContainer.appendChild(item);
        });
        analyzeBtn.disabled = uploadedFiles.length === 0;
    }
    previewContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-file-btn')) {
            uploadedFiles.splice(parseInt(e.target.dataset.index, 10), 1);
            renderPreviews();
        }
    });
});
</script>
</body>
</html>
