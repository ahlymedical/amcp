<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>الشبكة الطبية — الأهلي للخدمات الطبية</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
  body{font-family:Tahoma, Arial, sans-serif;background:#f7f7f7;margin:0}
  .container{max-width:980px;margin:auto;padding:16px}
  .section{background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.06);padding:16px;margin:12px 0}
  h2{margin:6px 0 12px}
  textarea,input[type="text"]{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px}
  button{width:100%;background:#006a4e;color:#fff;border:0;border-radius:10px;padding:12px;cursor:pointer;font-weight:bold}
  button:hover{opacity:.95}
  .muted{color:#666;font-size:13px}
  .loader{display:none;border:4px solid #eee;border-top:4px solid #006a4e;border-radius:50%;width:28px;height:28px;animation:spin 1s linear infinite;margin:10px auto}
  @keyframes spin{100%{transform:rotate(360deg)}}

  .card{border:1px solid #e7e7e7;border-radius:12px;padding:12px;margin:10px 0;background:#fff}
  .card.best{border:2px solid #006a4e;box-shadow:0 0 0 4px rgba(0,106,78,.08)}
  .badge{display:inline-flex;align-items:center;gap:6px;background:#006a4e;color:#fff;border-radius:999px;padding:4px 10px;font-size:12px;margin-bottom:8px}
  .stars{color:#ffc107}
  .row{display:flex;gap:10px;align-items:flex-start}
  .icon{width:44px;height:44px;border-radius:50%;background:#e7f1ed;display:inline-flex;align-items:center;justify-content:center;color:#006a4e;font-size:20px}
  .title{font-weight:bold}
  .small{font-size:12px;color:#666}
  .pill{display:inline-block;background:#f3f5f7;border-radius:999px;padding:2px 8px;margin:2px 4px}
  .actions a{display:inline-block;margin:4px;padding:10px;border-radius:10px;background:#f1f1f1;color:#006a4e;text-decoration:none}
  .actions a:hover{background:#006a4e;color:#fff}
  .map-wrap{position:relative;border-radius:12px;overflow:hidden}
  .map-wrap::after{content:"اضغط لفتح الموقع في الخرائط";position:absolute;bottom:6px;right:6px;background:rgba(0,106,78,.85);color:#fff;padding:4px 8px;border-radius:6px;font-size:12px}
  .divider{height:1px;background:#eee;margin:12px 0}
  .hint{background:#fff9e6;border:1px solid #ffe08a;color:#7a5d00;padding:8px;border-radius:8px;font-size:13px}
</style>
</head>
<body>

<div class="container">

  <!-- البحث بالأعراض -->
  <div class="section" id="search">
    <h2>🔎 البحث المتقدم في الشبكة الطبية</h2>
    <div class="muted">اكتب حاسس بإيه (بالعامية/العربي/الإنجليزي) وقولنا انت فين — هنرشّح لك التخصص والعيادات القريبة.</div>
    <div style="margin-top:10px"></div>
    <textarea id="symptoms" rows="3" placeholder="مثال: تعبان أوي ومصدع / severe headache"></textarea>
    <div style="height:10px"></div>
    <input id="place" type="text" placeholder="مثال: الطالبية هرم، الجيزة">
    <div style="height:10px"></div>
    <button id="btn-symptoms"><i class="fa-solid fa-robot"></i> ابحث الآن</button>
    <div id="load-sym" class="loader"></div>
    <div class="hint" style="margin-top:10px">
      مثال كتابة: <b>أنا في الجيزة</b> + <b>حاسس بإرهاق عام وصداع شديد</b> — النظام هيفهم السياق ويقترح التخصص المناسب، ويطلع أقرب مقدم خدمة.
    </div>
  </div>

  <!-- تحليل التقارير -->
  <div class="section">
    <h2>🧾 تحليل التقارير والتحاليل</h2>
    <div class="muted">ارفع تقاريرك (أي صيغة: صور/ PDF...) — هنحلّلها ونرشّح تخصص ومقدم خدمة قريب.</div>
    <div style="height:10px"></div>
    <input id="rep-place" type="text" placeholder="مكانك — مثال: الجيزة">
    <div style="height:6px"></div>
    <input id="rep-files" type="file" multiple>
    <div style="height:10px"></div>
    <button id="btn-analyze"><i class="fa-solid fa-file-medical"></i> حلّل التقارير</button>
    <div id="load-ana" class="loader"></div>
  </div>

  <!-- مخرجات الذكاء الاصطناعي -->
  <div class="section" id="ai-out" style="display:none"></div>

  <!-- النتائج -->
  <div class="section" id="results" style="display:none">
    <h3>📋 النتائج المقترحة</h3>
    <div id="cards"></div>
  </div>

  <!-- المقر الرئيسي -->
  <div class="section" id="hq">
    <h2>📍 المقر الرئيسي — الأهلي للخدمات الطبية</h2>
    <div class="map-wrap" id="hq-map" title="افتح في خرائط Google">
      <!-- خريطة المقر: 57 برج الجامعة، شارع مراد، ميدان النهضة، الجيزة -->
      <iframe
        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3454.495955148021!2d31.20786357555355!3d30.02262187493399!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x145846e49123862b%3A0x12f5a6396017366d!2s57%20El%20Gamaa%20Tower%2C%20Mourad%20St.%20El%20Nahda%20Sq.%2C%20Giza!5e0!3m2!1sen!2seg!4v0000000000000"
        width="100%" height="320" style="border:0" allowfullscreen="" loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
    <div style="height:6px"></div>
    <div class="muted">العنوان: 57 برج الجامعة، شارع مراد، ميدان النهضة، الجيزة</div>
  </div>

</div>

<script>
  // ===== أيقونات التخصصات (ستايل قديم/بسيط وبروفشنال) =====
  const iconMap = {
    "default":"fa-user-doctor",
    "باطنه":"fa-stethoscope",
    "قلب":"fa-heart-pulse","قلبيه":"fa-heart-pulse",
    "صدر":"fa-lungs",
    "مخ":"fa-brain","اعصاب":"fa-brain",
    "نساء":"fa-person-pregnant","اطفال":"fa-child-reaching",
    "عيون":"fa-eye","جلديه":"fa-hand-dots",
    "عظام":"fa-bone",
    "انف":"fa-head-side-cough","اذن":"fa-head-side-cough","حنجره":"fa-head-side-cough",
    "مسالك":"fa-toilet-paper",
    "اسنان":"fa-tooth",
    "صيدليه":"fa-pills",
    "اشعه":"fa-x-ray",
    "معمل":"fa-vial",
    "مستشفى":"fa-hospital"
  };
  function getIconClass(txt){
    const s = (txt||"").toLowerCase();
    for (const k in iconMap) {
      if (k !== "default" && s.includes(k)) return "fa-solid " + iconMap[k];
    }
    return "fa-solid " + iconMap["default"];
  }

  // ===== مكوّنات العرض =====
  function showAI(data){
    const box = document.getElementById("ai-out");
    box.style.display = "block";
    box.innerHTML = `
      <div><b>💡 الشرح الطبي:</b> ${data.doctor_explanation || data.interpretation || "-"}</div>
      <div class="divider"></div>
      <div><b>🩺 التخصص الأنسب:</b> ${data.recommended_specialty || "-"} ${data.resolved_location?`— بالقرب من <b>${data.resolved_location}</b>`:""}</div>
      <div class="divider"></div>
      <div><b>📌 نصائح مبدئية:</b>
        <ul>${(data.temporary_advice||[]).map(x=>`<li>${x}</li>`).join("")}</ul>
      </div>
    `;
  }

  function phonesPills(phones){
    return (phones||[]).map(p=>`<span class="pill">${p}</span>`).join("");
  }

  function showProviders(list){
    const wrap = document.getElementById("cards");
    wrap.innerHTML = "";
    document.getElementById("results").style.display = "block";
    list.forEach(p=>{
      const ico = getIconClass((p.specialty_sub||"") + " " + (p.provider_type||""));
      wrap.innerHTML += `
        <div class="card ${p.best?"best":""}" id="${p.id}">
          ${p.best?`<div class="badge"><i class="fa-solid fa-star stars"></i> الترشيح الأنسب <span class="stars">★★★★★</span></div>`:""}
          <div class="row">
            <div class="icon"><i class="${ico}"></i></div>
            <div>
              <div class="title">${p.name||"-"}</div>
              <div class="small">${(p.specialty_sub||p.provider_type||"-")}</div>
            </div>
          </div>
          <div class="divider"></div>
          <div><i class="fa-solid fa-location-dot"></i> ${p.address||"-"} <span class="small">(${p.governorate||"-"})</span></div>
          <div style="margin-top:6px"><i class="fa-solid fa-phone"></i> ${phonesPills(p.phones)}</div>
          ${p.hotline?`<div style="margin-top:6px"><i class="fa-solid fa-fire"></i> Hotline: <b>${p.hotline}</b></div>`:""}
          <div class="divider"></div>
          <div class="actions">
            <a href="#search" title="الرجوع لصندوق البحث"><i class="fa-solid fa-arrow-up"></i></a>
            <a target="_blank" href="${p.maps_url}" title="افتح GPS/خرائط Google"><i class="fa-solid fa-location-arrow"></i></a>
            <a href="#hq" title="الذهاب إلى خريطة المقر"><i class="fa-solid fa-arrow-down"></i></a>
          </div>
        </div>
      `;
    });
    // نزول تلقائي لأوّل نتيجة بعد البحث
    if (list.length){ location.hash = "#" + list[0].id; }
  }

  // ===== استدعاءات API =====
  document.getElementById("btn-symptoms").onclick = async () => {
    const s = document.getElementById("symptoms").value.trim();
    const l = document.getElementById("place").value.trim();
    if (!s){ alert("من فضلك اكتب الأعراض."); return; }
    if (!l){ alert("من فضلك اكتب مكانك (مثال: الطالبية هرم، الجيزة)."); return; }
    document.getElementById("load-sym").style.display = "block";
    const res = await fetch("/api/symptoms", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({symptoms:s, location:l})
    });
    const data = await res.json();
    document.getElementById("load-sym").style.display = "none";
    showAI(data);
    showProviders(data.providers || []);
  };

  document.getElementById("btn-analyze").onclick = async () => {
    const l = document.getElementById("rep-place").value.trim();
    if (!l){ alert("من فضلك اكتب مكانك (مثال: الجيزة)."); return; }
    const files = document.getElementById("rep-files").files;
    if (!files.length){ alert("ارفع ملف أو أكثر للتحليل."); return; }
    const arr = [];
    for (const f of files){
      const buf = await f.arrayBuffer();
      const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
      arr.push({mime_type: f.type || "application/octet-stream", data: b64});
    }
    document.getElementById("load-ana").style.display = "block";
    const res = await fetch("/api/reports", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({files:arr, location:l})
    });
    const data = await res.json();
    document.getElementById("load-ana").style.display = "none";
    showAI(data);
    showProviders(data.providers || []);
  };

  // خريطة المقر — فتح GPS عند الضغط
  document.getElementById("hq-map").onclick = () => {
    window.open(
      "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent("57 El Gamaa Tower, Mourad St., El Nahda Sq., Giza, Egypt"),
      "_blank"
    );
  };
</script>
</body>
</html>
